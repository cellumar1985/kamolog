<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>kamolog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body {
      font-family: sans-serif;
      padding: 10px;
    }
    input, button {
      display: block;
      margin: 8px 0;
      font-size: 16px;
      width: 100%;
      max-width: 420px;
    }
    button {
      padding: 10px;
      cursor: pointer;
    }
    img {
      max-width: 100%;
      margin-top: 5px;
      border-radius: 10px;
    }
    .record {
      border-bottom: 1px solid #ccc;
      padding: 10px 0;
    }
    .small {
      font-size: 12px;
      opacity: 0.7;
    }
  </style>

  <!-- Firebase + Firestore -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      getDocs,
      query,
      orderBy,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

    // FirebaseË®≠ÂÆöÔºà„Éû„Çµ„É¶„Ç≠„ÅÆ„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÔºâ
    const firebaseConfig = {
      apiKey: "AIzaSyC_Qi-AMJBo0ZY0dYn2KOLPALdkuq4zjJ4",
      authDomain: "kamolog-537fd.firebaseapp.com",
      projectId: "kamolog-537fd",
      storageBucket: "kamolog-537fd.firebasestorage.app",
      messagingSenderId: "855371003036",
      appId: "1:855371003036:web:3364d4727964e3bccf2959"
    };

    // ÂàùÊúüÂåñ
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Firestore„ÅÆ‰øùÂ≠òÂÖàÔºà„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥ÂêçÔºâ
    const kamoCol = collection(db, "kamologRecords");

    // HTMLÂÅ¥„Åã„ÇâÂëº„Åπ„Çã„Çà„ÅÜ„Å´ window „Å´Èñ¢Êï∞„ÇíÁôªÈå≤
    window.saveRecord = saveRecord;
    window.loadRecords = loadRecords;

    // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ
    window.addEventListener("DOMContentLoaded", () => {
      loadRecords();
    });

    // =========================
    // ÁîªÂÉèÂúßÁ∏ÆÔºà„Çπ„Éû„ÉõÂØæÁ≠ñÔºâ
    // =========================
    async function compressImageToBase64(file, maxWidth = 900, quality = 0.7) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          const img = new Image();
          img.onload = () => {
            const ratio = img.width / img.height;
            const width = Math.min(maxWidth, img.width);
            const height = Math.round(width / ratio);

            const canvas = document.createElement("canvas");
            canvas.width = width;
            canvas.height = height;

            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0, width, height);

            const base64 = canvas.toDataURL("image/jpeg", quality);
            resolve(base64);
          };
          img.onerror = reject;
          img.src = reader.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // =========================
    // ‰øùÂ≠òÔºàFirestore„Å∏Ôºâ
    // =========================
    async function saveRecord() {
      const kamo = document.getElementById("kamo").value.trim();
      const place = document.getElementById("place").value.trim();
      const fileInput = document.getElementById("photo");
      const file = fileInput.files[0];

      if (!kamo || !place) {
        alert("„Ç´„Éº„É¢„ÅÆÂêçÂâç„Å®Â†¥ÊâÄ„ÅØÂøÖÈ†à„Å†„ÇàÔºÅ");
        return;
      }

      // ‰øùÂ≠ò‰∏≠Ë°®Á§∫
      const btn = document.getElementById("saveBtn");
      btn.disabled = true;
      btn.textContent = "‰øùÂ≠ò‰∏≠‚Ä¶";

      try {
        let photoBase64 = null;

        if (file) {
          // Firestore„Å´Èáç„ÅÑÁîªÂÉè„ÅØÂç±Èô∫„Å™„ÅÆ„ÅßÂúßÁ∏Æ
          photoBase64 = await compressImageToBase64(file, 900, 0.7);
        }

        // Firestore„Å´‰øùÂ≠ò
        await addDoc(kamoCol, {
          kamo,
          place,
          photo: photoBase64,
          createdAt: serverTimestamp()
        });

        // „Éï„Ç©„Éº„É†„ÇØ„É™„Ç¢
        clearForm();

        // ÂÜçË™≠„ÅøËæº„ÅøÔºàÊúÄÊñ∞ÂèçÊò†Ôºâ
        await loadRecords();

        alert("‰øùÂ≠ò„Åó„Åü„Ç¨„ÉºÔºÅü¶Ü‚ú®");
      } catch (e) {
        console.error(e);
        alert("‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åü„Ç¨‚Ä¶Ôºà„Ç≥„É≥„ÇΩ„Éº„É´Ë¶ã„Å¶Ôºâ");
      } finally {
        btn.disabled = false;
        btn.textContent = "‰øùÂ≠ò";
      }
    }

    // =========================
    // Ë™≠„ÅøËæº„ÅøÔºàFirestore„Åã„ÇâÔºâ
    // =========================
    async function loadRecords() {
      const list = document.getElementById("recordList");
      list.innerHTML = "Ë™≠„ÅøËæº„Åø‰∏≠‚Ä¶";

      try {
        // createdAtÈ†Ü„Å´‰∏¶„Åπ„Çã
        const q = query(kamoCol, orderBy("createdAt", "desc"));
        const snapshot = await getDocs(q);

        list.innerHTML = "";

        snapshot.forEach(doc => {
          const r = doc.data();

          const div = document.createElement("div");
          div.className = "record";
          div.innerHTML = `
            <p>ü¶Ü ${escapeHtml(r.kamo)} / üìç ${escapeHtml(r.place)}</p>
            ${r.photo ? `<img src="${r.photo}" alt="photo">` : ""}
            <p class="small">id: ${doc.id}</p>
          `;
          list.appendChild(div);
        });

        if (snapshot.size === 0) {
          list.innerHTML = "<p>„Åæ„Å†Ë®òÈå≤„Åå„Å™„ÅÑ„ÇàÔºÅ</p>";
        }
      } catch (e) {
        console.error(e);
        list.innerHTML = "<p>Ë™≠„ÅøËæº„ÅøÂ§±Êïó‚Ä¶Ôºà„Ç≥„É≥„ÇΩ„Éº„É´Ë¶ã„Å¶Ôºâ</p>";
      }
    }

    // =========================
    // Â∞èÁâ©
    // =========================
    function clearForm() {
      document.getElementById("kamo").value = "";
      document.getElementById("place").value = "";
      document.getElementById("photo").value = "";
    }

    function escapeHtml(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }
  </script>
</head>

<body>
  <h1>ü¶Ü „Ç´„É¢„É≠„Ç∞</h1>

  <!-- ÂÖ•Âäõ„Éï„Ç©„Éº„É† -->
  <input type="text" id="kamo" placeholder="„Ç´„Éº„É¢„ÅÆÂêçÂâçÔºà‰æãÔºö„Ç´„É´„Ç¨„Éº„É¢Ôºâ" />
  <input type="text" id="place" placeholder="Â†¥ÊâÄÔºà‰æãÔºö„ÅÇ„Å•„ÅæÈÅãÂãïÂÖ¨ÂúíÔºâ" />
  <input type="file" id="photo" accept="image/*" />

  <button id="saveBtn" onclick="saveRecord()">‰øùÂ≠ò</button>

  <hr />

  <!-- Ë°®Á§∫„Ç®„É™„Ç¢ -->
  <div id="recordList"></div>
</body>
</html>
